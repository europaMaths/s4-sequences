<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>nth Term Practice</title>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px auto;
      max-width: 700px;
      padding: 20px;
      background-color: #f9fafb;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    label {
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 18px;
      margin: 10px 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
    .feedback {
      margin-top: 20px;
      font-size: 1.1em;
      text-align: left;
    }
    .question {
      font-size: 1.5em;
      text-align: center;
      margin: 20px 0;
      letter-spacing: 2px;
    }
  </style>
</head>
<body>
  <h1>Find the nth Term of a Sequence</h1>

  <label><input type="checkbox" name="mode" value="linear" checked> Linear Sequences</label>
  <label><input type="checkbox" name="mode" value="geometric"> Geometric Sequences</label>
  <label><input type="checkbox" name="mode" value="quadratic"> Quadratic Sequences</label>

  <p style="text-align:center;">Find the formula for the nth term \(T_n\) of the sequence:</p>
  <div class="question" id="question"></div>
  <input type="text" id="userAnswer" placeholder="Type your formula for the nth term here (e.g., 2n+3 or 5*(1/2)^(n-1))">
  <div style="text-align:center">
    <button onclick="generateQuestion()">Generate Question</button>
    <button onclick="checkAnswer()">Check Answer</button>
    <button id="giveUpBtn" onclick="showSolution()" style="display: none;">Give Up</button>
  </div>
  <div class="feedback" id="feedback"></div>

  <script>
    window.addEventListener("load", () => {
      if (typeof MathJax !== "undefined") {
        generateQuestion();
      } else {
        console.error("MathJax failed to load.");
      }
    });

    let correctAnswer = "";
    let steps = "";
    let currentMode = ""; 

    function gcd(a, b) {
        return b === 0 ? a : gcd(b, a % b);
    }
    
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function getRandomDecimal(min, max, dp) {
        const factor = Math.pow(10, dp);
        let num = Math.random() * (max - min) + min;
        return Math.round(num * factor) / factor;
    }

    function generateQuestion() {
      document.getElementById("giveUpBtn").style.display = "none";
      document.getElementById("feedback").innerHTML = "";
      document.getElementById("userAnswer").value = "";

      const checkedBoxes = document.querySelectorAll('input[name="mode"]:checked');
      let selectedModes = Array.from(checkedBoxes).map(box => box.value);

      if (selectedModes.length === 0) {
        selectedModes.push('linear');
        document.querySelector('input[value="linear"]').checked = true;
      }
      
      const mode = selectedModes[Math.floor(Math.random() * selectedModes.length)];
      currentMode = mode; 

      if (mode === "linear") {
        generateLinearSequence();
      } else if (mode === "geometric") {
        generateGeometricSequence();
      } else { // quadratic
        generateQuadraticSequence();
      }
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }

    function generateLinearSequence() {
      const isDecimal = Math.random() > 0.6; 
      let a, b;

      if (isDecimal) {
        a = getRandomDecimal(-5, 5, 1);
        while (a === 0) a = getRandomDecimal(-5, 5, 1);
        b = getRandomDecimal(-10, 10, 1);
      } else {
        a = getRandomInt(-10, 10);
        while (a === 0) a = getRandomInt(-10, 10);
        b = getRandomInt(-10, 10);
      }
      
      const sequence = Array.from({ length: 5 }, (_, i) => a * (i + 1) + b);
      const displaySequence = sequence.map(n => n.toFixed(1).replace('.0', '')).join(', ');
      
      const aStr = a === 1 ? "n" : a === -1 ? "-n" : `${a}n`;
      const bStr = b === 0 ? "" : (b > 0 ? `+${b}` : `${b}`);
      correctAnswer = `${aStr}${bStr}`.replace('.0','');

      const t1 = sequence[0].toFixed(1).replace('.0', '');
      const t2 = sequence[1].toFixed(1).replace('.0', '');
      const aDisplay = a.toFixed(1).replace('.0', '');
      const bDisplay = b.toFixed(1).replace('.0', '');
      
      const anSequence = Array.from({ length: 5 }, (_, i) => a * (i + 1));
      const anDisplay = anSequence.map(n => n.toFixed(1).replace('.0', '')).join(', ');

      steps = `<h3>Worked Solution (Linear)</h3>
        <b>Step 1: Find the common difference.</b><br>
        Subtract consecutive terms: \\(${t2} - ${t1} = ${aDisplay}\\).<br>
        The common difference is \\(${aDisplay}\\), so the formula starts with \\(${aStr}\\).<br><br>
        <b>Step 2: Find the 'zeroth' term.</b><br>
        Write the original sequence and the \\(${aStr}\\) sequence underneath.<br>
        Sequence: \\(${displaySequence}\\)<br>
        \\(${aStr}\\): \\(${anDisplay}\\)<br>
        Now find the difference: (Sequence) - (\\(${aStr}\\)) = \\(${bDisplay}\\).<br>
        This value is \\(b\\).<br><br>
        <b>Step 3: Combine to get the final formula.</b><br>
        The formula is \\(an + b\\).<br>
        Final Answer: \\(${correctAnswer}\\)`;
        
      document.getElementById("question").innerHTML = `\\( ${displaySequence} \\)`;
    }

    function generateGeometricSequence() {
      let a, r, rDisplay, rAnswer;
      const rand = Math.random();

      if (rand < 0.3) { // Positive Integer
        a = getRandomInt(2, 10);
        r = getRandomInt(2, 4);
        rDisplay = r.toString();
        rAnswer = r.toString();
      } else if (rand < 0.6) { // Unit Fraction
        const den = getRandomInt(2, 4);
        a = getRandomInt(1, 3) * den * den; // Ensure first 3 terms are integers
        r = { num: 1, den };
        rDisplay = `\\frac{1}{${den}}`;
        rAnswer = `(1/${den})`;
      } else if (rand < 0.8) { // Negative Integer
        a = getRandomInt(2, 10);
        r = getRandomInt(-4, -2);
        rDisplay = `(${r})`;
        rAnswer = `(${r})`;
      } else { // Non-unit Fraction
        let num = getRandomInt(2, 4);
        let den = num + getRandomInt(1, 2);
        const commonDivisor = gcd(num, den); // Simplify the base ratio
        num /= commonDivisor;
        den /= commonDivisor;
        const isNeg = Math.random() < 0.5;
        if (isNeg) num = -num;

        a = getRandomInt(1, 3) * den * den; // Ensure first 3 terms are integers
        r = { num, den };
        rDisplay = isNeg ? `(-\\frac{${Math.abs(num)}}{${den}})` : `\\frac{${num}}{${den}}`;
        rAnswer = `(${isNeg ? '-' : ''}${Math.abs(num)}/${den})`;
      }

      const displaySequence = [];
      for (let n = 1; n <= 5; n++) {
        if (typeof r === 'number') {
          displaySequence.push(a * Math.pow(r, n - 1));
        } else {
          let num = a * Math.pow(r.num, n - 1);
          let den = Math.pow(r.den, n - 1);
          const commonDivisor = gcd(Math.abs(num), Math.abs(den));
          let sNum = num / commonDivisor;
          let sDen = den / commonDivisor;

          if (sDen < 0) { sDen = -sDen; sNum = -sNum; } // Keep denominator positive
          
          if (sDen === 1) {
            displaySequence.push(sNum);
          } else {
            displaySequence.push(`\\frac{${sNum}}{${sDen}}`);
          }
        }
      }
      
      correctAnswer = `${a}*${rAnswer}^(n-1)`;
      const t1Display = displaySequence[0];
      const t2Display = displaySequence[1];
      
      steps = `<h3>Worked Solution (Geometric)</h3>
        <b>Step 1: Find the common ratio (r).</b><br>
        Divide a term by the previous term: \\(r = T_2 \\div T_1 = ${t2Display} \\div ${t1Display} = ${rDisplay}\\).<br><br>
        <b>Step 2: Identify the first term (a).</b><br>
        The first term is \\(a = ${a}\\).<br><br>
        <b>Step 3: Use the general formula \\(T_n = a \\cdot r^{n-1}\\).</b><br>
        Substitute the values for \\(a\\) and \\(r\\).<br>
        Final Answer: \\(${a} \\cdot ${rDisplay}^{(n-1)}\\)`;
        
      document.getElementById("question").innerHTML = `\\( ${displaySequence.join(',\\ ')} \\)`;
    }
    
    function generateQuadraticSequence() {
      const a = getRandomInt(1, 5);
      const b = getRandomInt(-5, 5);
      const c = getRandomInt(-5, 5);

      const sequence = Array.from({ length: 5 }, (_, i) => a * (i + 1)**2 + b * (i + 1) + c);
      const displaySequence = sequence.join(', ');

      const aTerm = a === 1 ? 'n^2' : (a === -1 ? '-n^2' : `${a}n^2`);
      let bTerm = b === 0 ? '' : (b === 1 ? '+n' : (b === -1 ? '-n' : (b > 0 ? `+${b}n` : `${b}n`)));
      let cTerm = c === 0 ? '' : (c > 0 ? `+${c}` : `${c}`);
      correctAnswer = `${aTerm}${bTerm}${cTerm}`.replace(/^\+/, '');

      const firstDiffs = Array.from({ length: 4 }, (_, i) => sequence[i+1] - sequence[i]);
      const secondDiffs = Array.from({ length: 3 }, (_, i) => firstDiffs[i+1] - firstDiffs[i]);
      const secondDiff = secondDiffs[0];

      const an2Sequence = Array.from({ length: 5 }, (_, i) => a * (i + 1)**2);
      const linearSequence = Array.from({ length: 5 }, (_, i) => sequence[i] - an2Sequence[i]);
      const linearDiff = linearSequence[1] - linearSequence[0];
      const linearB = linearSequence[0] - linearDiff;
      
      let linearTerm = linearDiff === 0 ? '' : (linearDiff === 1 ? '+n' : (linearDiff === -1 ? '-n' : (linearDiff > 0 ? `+${linearDiff}n` : `${linearDiff}n`)));
      let linearConst = linearB === 0 ? '' : (linearB > 0 ? `+${linearB}` : `${linearB}`);
      
      steps = `<h3>Worked Solution (Quadratic)</h3>
        <b>Step 1: Find the first and second differences.</b><br>
        Sequence: \\(${displaySequence}\\)<br>
        First Differences: \\(${firstDiffs.join(', ')}\\)<br>
        Second Differences: \\(${secondDiffs.join(', ')}\\)<br><br>
        <b>Step 2: Find the value of 'a'.</b><br>
        The rule is \\(a = \\frac{\\text{Second Difference}}{2}\\).<br>
        \\(a = \\frac{${secondDiff}}{2} = ${a}\\). The formula starts with \\(${aTerm}\\).<br><br>
        <b>Step 3: Subtract the \\(${aTerm}\\) sequence.</b><br>
        Original Sequence: \\(${displaySequence}\\)<br>
        \\(${aTerm}\\) Sequence: \\(${an2Sequence.join(', ')}\\)<br>
        (Original) - (\\(${aTerm}\\)): \\(${linearSequence.join(', ')}\\)<br><br>
        <b>Step 4: Find the rule for the new linear sequence.</b><br>
        This new sequence has a common difference of \\(${linearDiff}\\), and a 'zeroth' term of \\(${linearB}\\).<br>
        So its rule is \\(${linearTerm}${linearConst}\\).<br><br>
        <b>Step 5: Combine the parts.</b><br>
        The quadratic part is \\(${aTerm}\\) and the linear part is \\(${linearTerm}${linearConst}\\).<br>
        Final Answer: \\(${correctAnswer.replace(/^\+/, '')}\\)`;
        
      document.getElementById("question").innerHTML = `\\( ${displaySequence} \\)`;
    }

    function normalizeAnswer(input) {
        return input.toLowerCase().replace(/\s/g, '').replace(/\*/g, '');
    }
    
    function sortTerms(expr) {
        if (!expr.startsWith('+') && !expr.startsWith('-')) {
            expr = '+' + expr;
        }
        const terms = expr.match(/[+-][^+-]*/g) || [];
        terms.sort((a, b) => {
            const powerA = a.includes('n^2') ? 2 : (a.includes('n') ? 1 : 0);
            const powerB = b.includes('n^2') ? 2 : (b.includes('n') ? 1 : 0);
            return powerB - powerA;
        });
        let sortedExpr = terms.join('');
        return sortedExpr.startsWith('+') ? sortedExpr.substring(1) : sortedExpr;
    }

    function checkAnswer() {
      let userAnswer = normalizeAnswer(document.getElementById("userAnswer").value);
      let correctAnswerNorm = normalizeAnswer(correctAnswer);
      
      let isCorrect = false;
      if (currentMode === 'geometric') {
        isCorrect = (userAnswer === correctAnswerNorm);
      } else {
        isCorrect = (sortTerms(userAnswer) === sortTerms(correctAnswerNorm));
      }

      if (isCorrect) {
        document.getElementById("feedback").innerHTML = "<span style='color: green; font-weight: bold;'>✅ Correct! Well done.</span>";
        document.getElementById("giveUpBtn").style.display = "none";
      } else {
        document.getElementById("feedback").innerHTML = "<span style='color: red; font-weight: bold;'>❌ Not quite. Check your working and try again.</span>";
        document.getElementById("giveUpBtn").style.display = "inline-block";
      }
    }

    function showSolution() {
      document.getElementById("feedback").innerHTML = `${steps}`;
      MathJax.Hub.Queue(["Typeset", MathJax.Hub, "feedback"]);
    }
  </script>
</body>

</html>
